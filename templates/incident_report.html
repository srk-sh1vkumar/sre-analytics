{% extends "base.html" %}

{% block title %}Incident Analysis Report{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h2 text-warning mb-2">
                    <i class="fas fa-exclamation-triangle me-3"></i>
                    Incident Analysis Report
                </h1>
                <p class="text-muted">Generate detailed incident reports with AI-powered root cause analysis</p>
            </div>
            <a href="/" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>
                Back to Dashboard
            </a>
        </div>
    </div>
</div>

<!-- Alert Container -->
<div id="alert-container" class="mb-4"></div>

<!-- Report Configuration Form -->
<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Incident Configuration
                </h4>
            </div>
            <div class="card-body">
                <form id="incident-report-form">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="app_name" class="form-label">
                                <i class="fas fa-cube me-2"></i>
                                Application Name *
                            </label>
                            <select class="form-select" id="app_name" name="app_name" required>
                                <option value="">Loading applications...</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="incident_scope" class="form-label">
                                <i class="fas fa-crosshairs me-2"></i>
                                Incident Scope
                            </label>
                            <select class="form-select" id="incident_scope" name="incident_scope">
                                <option value="application">Application-wide</option>
                                <option value="service">Service-specific</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-3" id="custom_app_name" style="display: none;">
                        <label for="custom_app_name_input" class="form-label">
                            <i class="fas fa-edit me-2"></i>
                            Custom Application Name
                        </label>
                        <input type="text" class="form-control" id="custom_app_name_input" name="custom_app_name_input"
                               placeholder="Enter your custom application name">
                    </div>

                    <div class="mb-3">
                        <label for="services" class="form-label">
                            <i class="fas fa-server me-2"></i>
                            <span id="services_label">Affected Services *</span>
                        </label>
                        <textarea class="form-control" id="services" name="services" rows="3"
                                  placeholder="web-frontend, api-gateway, payment-service" required></textarea>
                        <div class="form-text" id="services_help">Enter the names of services that were affected by the incident</div>
                    </div>

                    <div class="mb-3" id="service_selection" style="display: none;">
                        <label class="form-label">
                            <i class="fas fa-bullseye me-2"></i>
                            Primary Affected Service *
                        </label>
                        <select class="form-select" id="target_service" name="target_service">
                            <option value="">Select the main service...</option>
                        </select>
                        <div class="form-text">Choose the service that was most impacted by the incident</div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="incident_time" class="form-label">
                                <i class="fas fa-clock me-2"></i>
                                Incident Start Time
                            </label>
                            <input type="datetime-local" class="form-control" id="incident_time" name="incident_time">
                            <div class="form-text">Leave blank to analyze the last 2 hours</div>
                        </div>
                        <div class="col-md-6">
                            <label for="duration" class="form-label">
                                <i class="fas fa-hourglass-half me-2"></i>
                                Duration (hours)
                            </label>
                            <select class="form-select" id="duration" name="duration">
                                <option value="0.5">30 minutes</option>
                                <option value="1" selected>1 hour</option>
                                <option value="2">2 hours</option>
                                <option value="4">4 hours</option>
                                <option value="8">8 hours</option>
                                <option value="24">24 hours</option>
                            </select>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="incident_severity" class="form-label">
                            <i class="fas fa-thermometer-half me-2"></i>
                            Incident Severity
                        </label>
                        <select class="form-select" id="incident_severity" name="incident_severity">
                            <option value="1">Critical - System Down</option>
                            <option value="2" selected>High - Major Impact</option>
                            <option value="3">Medium - Moderate Impact</option>
                            <option value="4">Low - Minor Impact</option>
                        </select>
                    </div>

                    <div class="mb-4">
                        <label for="incident_description" class="form-label">
                            <i class="fas fa-file-alt me-2"></i>
                            Incident Description (Optional)
                        </label>
                        <textarea class="form-control" id="incident_description" name="incident_description" rows="3"
                                  placeholder="Describe what happened during the incident..."></textarea>
                        <div class="form-text">Provide any additional context about the incident</div>
                    </div>

                    <div class="mb-4">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include_rca" checked>
                            <label class="form-check-label" for="include_rca">
                                <i class="fas fa-search me-2"></i>
                                Include AI-powered root cause analysis
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include_snapshots" checked>
                            <label class="form-check-label" for="include_snapshots">
                                <i class="fas fa-camera me-2"></i>
                                Include performance snapshots during incident
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="include_recommendations" checked>
                            <label class="form-check-label" for="include_recommendations">
                                <i class="fas fa-lightbulb me-2"></i>
                                Include remediation recommendations
                            </label>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-warning btn-lg" id="generate-btn">
                        <i class="fas fa-play me-2"></i>
                        Generate Incident Report
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Incident Analysis Preview -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-microscope me-2"></i>
                    Analysis Preview
                </h5>
            </div>
            <div class="card-body">
                <div class="text-muted small">
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-timeline me-1"></i> Incident Timeline</span>
                        <i class="fas fa-check text-success"></i>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-search me-1"></i> Root Cause Analysis</span>
                        <i class="fas fa-check text-success"></i>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-chart-area me-1"></i> Performance Impact</span>
                        <i class="fas fa-check text-success"></i>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-brain me-1"></i> AI Insights</span>
                        <i class="fas fa-check text-success"></i>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span><i class="fas fa-tools me-1"></i> Recommendations</span>
                        <i class="fas fa-check text-success"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Severity Guide -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Severity Guide
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-2">
                    <span class="badge bg-danger me-2">Critical</span>
                    <small>Complete system outage</small>
                </div>
                <div class="mb-2">
                    <span class="badge bg-warning me-2">High</span>
                    <small>Major functionality affected</small>
                </div>
                <div class="mb-2">
                    <span class="badge bg-info me-2">Medium</span>
                    <small>Some features impacted</small>
                </div>
                <div class="mb-2">
                    <span class="badge bg-secondary me-2">Low</span>
                    <small>Minor issues or degradation</small>
                </div>
            </div>
        </div>

        <!-- Quick Incident Examples -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-fire me-2"></i>
                    Common Incidents
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <button class="btn btn-outline-danger btn-sm w-100" onclick="fillIncidentExample('outage')">
                        <i class="fas fa-power-off me-2"></i>
                        Service Outage
                    </button>
                </div>
                <div class="mb-3">
                    <button class="btn btn-outline-warning btn-sm w-100" onclick="fillIncidentExample('performance')">
                        <i class="fas fa-turtle me-2"></i>
                        Performance Degradation
                    </button>
                </div>
                <div class="mb-3">
                    <button class="btn btn-outline-info btn-sm w-100" onclick="fillIncidentExample('errors')">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Error Spike
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Section (Hidden by default) -->
<div id="progress-section" class="row mt-4" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-cogs me-2"></i>
                    Incident Analysis Progress
                </h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3" style="height: 20px;">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                         role="progressbar" style="width: 0%"></div>
                </div>
                <p id="progress-message" class="mb-0 text-muted">Initializing...</p>
            </div>
        </div>
    </div>
</div>

<!-- Results Section (Hidden by default) -->
<div id="results-section" class="row mt-4" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-download me-2"></i>
                    Generated Incident Report
                </h5>
            </div>
            <div class="card-body">
                <div id="download-buttons" class="d-grid gap-2 d-md-flex">
                    <!-- Download buttons will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentTaskId = null;
let progressInterval = null;

$(document).ready(function() {
    // Set default incident time to 2 hours ago
    const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000);
    const timeString = twoHoursAgo.toISOString().slice(0, 16);
    $('#incident_time').val(timeString);

    $('#incident-report-form').on('submit', function(e) {
        e.preventDefault();
        generateIncidentReport();
    });

    // Load AppDynamics applications
    loadAppDynamicsApplications();

    // Handle application dropdown changes
    $('#app_name').on('change', function() {
        const value = $(this).val();
        if (value === 'custom') {
            $('#custom_app_name').show();
            $('#custom_app_name_input').prop('required', true);
        } else {
            $('#custom_app_name').hide();
            $('#custom_app_name_input').prop('required', false);
        }
    });

    // Handle incident scope changes
    $('#incident_scope').on('change', function() {
        const scope = $(this).val();
        if (scope === 'service') {
            $('#services_label').text('All Services *');
            $('#services_help').text('Enter all services, then select the primary affected service');
            $('#service_selection').show();
            $('#target_service').prop('required', true);
        } else {
            $('#services_label').text('Affected Services *');
            $('#services_help').text('Enter the names of services that were affected by the incident');
            $('#service_selection').hide();
            $('#target_service').prop('required', false);
        }
    });

    // Update service dropdown when services are entered
    $('#services').on('input', function() {
        const servicesText = $(this).val().trim();
        const serviceDropdown = $('#target_service');

        // Clear existing options except the first one
        serviceDropdown.find('option:not(:first)').remove();

        if (servicesText && $('#incident_scope').val() === 'service') {
            const services = servicesText.split(',').map(s => s.trim()).filter(s => s);
            services.forEach(service => {
                serviceDropdown.append(`<option value="${service}">${service}</option>`);
            });
        }
    });
});

function fillIncidentExample(type) {
    const examples = {
        'outage': {
            app_name: 'E-commerce Platform',
            services: 'api-gateway, payment-service, order-service',
            severity: '1',
            description: 'Complete service outage affecting customer transactions and order processing'
        },
        'performance': {
            app_name: 'Banking System',
            services: 'web-portal, transaction-service, account-service',
            severity: '2',
            description: 'Significant performance degradation with response times exceeding 5 seconds'
        },
        'errors': {
            app_name: 'SaaS Platform',
            services: 'web-app, user-management, billing-service',
            severity: '3',
            description: 'Increased error rates in user authentication and billing processes'
        }
    };

    const example = examples[type];
    if (example) {
        $('#app_name').val(example.app_name).trigger('change');
        $('#services').val(example.services).trigger('input');
        $('#incident_severity').val(example.severity);
        $('#incident_description').val(example.description);
    }
}

function generateIncidentReport() {
    // Get application name
    let appName = $('#app_name').val();
    if (appName === 'custom') {
        appName = $('#custom_app_name_input').val().trim();
    }

    const formData = {
        report_type: 'incident',
        app_name: appName,
        services: $('#services').val().trim(),
        incident_scope: $('#incident_scope').val(),
        target_service: $('#target_service').val(),
        incident_time: $('#incident_time').val(),
        duration: $('#duration').val()
    };

    // Validate form
    if (!formData.app_name || !formData.services) {
        showAlert('danger', 'Please fill in all required fields.');
        return;
    }

    // Validate service-specific incident
    if (formData.incident_scope === 'service' && !formData.target_service) {
        showAlert('danger', 'Please select the primary affected service for service-specific analysis.');
        return;
    }

    const generateBtn = $('#generate-btn');
    showLoading(generateBtn, 'Starting Analysis...');

    // Hide previous results
    $('#results-section').hide();
    $('#progress-section').show();

    // Start incident report generation
    $.ajax({
        url: '/api/generate-report',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function(response) {
            currentTaskId = response.task_id;
            showAlert('info', 'Incident analysis started. This may take 60-90 seconds for comprehensive analysis...');

            // Start progress monitoring
            progressInterval = setInterval(checkProgress, 2000);
        },
        error: function(xhr, status, error) {
            hideLoading(generateBtn, 'Generate Incident Report');
            $('#progress-section').hide();

            let errorMessage = 'Failed to start incident analysis.';
            if (xhr.responseJSON && xhr.responseJSON.error) {
                errorMessage = xhr.responseJSON.error;
            }
            showAlert('danger', errorMessage);
        }
    });
}

function checkProgress() {
    if (!currentTaskId) return;

    $.get(`/api/task-status/${currentTaskId}`)
        .done(function(data) {
            updateProgress(data.progress || 0, data.message || 'Analyzing...');

            if (data.status === 'completed') {
                clearInterval(progressInterval);
                progressInterval = null;

                showAlert('success', 'Incident analysis completed successfully!');
                showDownloadButtons();
                hideLoading($('#generate-btn'), 'Generate Incident Report');
                $('#progress-section').hide();
                $('#results-section').show();

            } else if (data.status === 'error') {
                clearInterval(progressInterval);
                progressInterval = null;

                showAlert('danger', `Incident analysis failed: ${data.message}`);
                hideLoading($('#generate-btn'), 'Generate Incident Report');
                $('#progress-section').hide();
            }
        })
        .fail(function() {
            clearInterval(progressInterval);
            progressInterval = null;

            showAlert('danger', 'Lost connection to analysis service.');
            hideLoading($('#generate-btn'), 'Generate Incident Report');
            $('#progress-section').hide();
        });
}

function updateProgress(progress, message) {
    $('#progress-bar').css('width', progress + '%').attr('aria-valuenow', progress);
    $('#progress-message').text(message);
}

function showDownloadButtons() {
    const buttons = `
        <button class="btn btn-warning me-2" onclick="downloadReport('html')">
            <i class="fas fa-globe me-2"></i>
            Download HTML Report
        </button>
        <button class="btn btn-success me-2" onclick="downloadReport('pdf')">
            <i class="fas fa-file-pdf me-2"></i>
            Download PDF Report
        </button>
        <button class="btn btn-info me-2" onclick="downloadReport('json')">
            <i class="fas fa-code me-2"></i>
            Download JSON Data
        </button>
        <button class="btn btn-outline-secondary" onclick="generateNewReport()">
            <i class="fas fa-plus me-2"></i>
            Analyze New Incident
        </button>
    `;
    $('#download-buttons').html(buttons);
}

function downloadReport(format) {
    if (!currentTaskId) return;

    const downloadUrl = `/api/download-report/${currentTaskId}/${format}`;
    window.open(downloadUrl, '_blank');
}

function generateNewReport() {
    // Reset form and UI
    currentTaskId = null;
    $('#results-section').hide();
    $('#progress-section').hide();
    $('#alert-container').empty();
    $('#incident-report-form')[0].reset();

    // Reset default values
    const twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000);
    const timeString = twoHoursAgo.toISOString().slice(0, 16);
    $('#incident_time').val(timeString);
    $('#duration').val('1');
    $('#incident_severity').val('2');
    $('#include_rca').prop('checked', true);
    $('#include_snapshots').prop('checked', true);
    $('#include_recommendations').prop('checked', true);

    // Scroll to top
    $('html, body').animate({scrollTop: 0}, 'smooth');
}

function loadAppDynamicsApplications() {
    const dropdown = $('#app_name');

    $.get('/api/appdynamics-applications')
        .done(function(data) {
            dropdown.empty();

            if (data.success && data.applications && data.applications.length > 0) {
                dropdown.append('<option value="">Select an application...</option>');

                // Add AppDynamics applications
                data.applications.forEach(function(app) {
                    dropdown.append(`<option value="${app.name}" title="${app.description}">${app.name}</option>`);
                });

                // Add separator and custom option
                dropdown.append('<option disabled>────────────────</option>');
                dropdown.append('<option value="custom">Custom Application...</option>');

                console.log(`✅ Loaded ${data.applications.length} applications from AppDynamics`);

                // Auto-select ecommerce-microservices if available
                const ecommerceApp = data.applications.find(app =>
                    app.name.toLowerCase().includes('ecommerce') ||
                    app.name.toLowerCase().includes('e-commerce')
                );

                if (ecommerceApp) {
                    dropdown.val(ecommerceApp.name);
                    console.log(`🎯 Auto-selected: ${ecommerceApp.name}`);
                }

            } else {
                // Fallback to predefined list if AppDynamics not available
                console.log('⚠️ AppDynamics not available, using fallback applications');
                dropdown.empty();
                dropdown.append('<option value="">Select an application...</option>');
                dropdown.append('<option value="E-commerce Platform">E-commerce Platform</option>');
                dropdown.append('<option value="Banking System">Banking System</option>');
                dropdown.append('<option value="Trading Platform">Trading Platform</option>');
                dropdown.append('<option value="SaaS Platform">SaaS Platform</option>');
                dropdown.append('<option value="Healthcare System">Healthcare System</option>');
                dropdown.append('<option value="Insurance Platform">Insurance Platform</option>');
                dropdown.append('<option value="custom">Custom Application...</option>');
            }
        })
        .fail(function(xhr, status, error) {
            console.error('❌ Failed to load AppDynamics applications:', error);

            // Fallback to predefined list
            dropdown.empty();
            dropdown.append('<option value="">Select an application...</option>');
            dropdown.append('<option value="E-commerce Platform">E-commerce Platform</option>');
            dropdown.append('<option value="Banking System">Banking System</option>');
            dropdown.append('<option value="Trading Platform">Trading Platform</option>');
            dropdown.append('<option value="custom">Custom Application...</option>');
        });
}
</script>
{% endblock %}